<!-- Unidades de Medida Component using Unified Template -->
<div class="reference-crud-container">
  <!-- 1. HEADER SECTION -->
  <div class="header-section">
    <div class="title-section">
      <h2 class="entity-title">{{ entityDisplayName() }}</h2>
      <p class="entity-subtitle">{{ entityDescription() }}</p>
    </div>
    
    <div class="actions-section">
      <!-- Primary Action -->
      <p-button
        [label]="'Nova ' + entityDisplayName()"
        icon="pi pi-plus"
        (onClick)="novoItem()"
        class="p-button-primary new-item-btn"
        [disabled]="loading()">
      </p-button>
      
      <!-- Custom Actions 
      <p-button
        label="Calculadora"
        icon="pi pi-calculator"
        (onClick)="executeCustomAction('conversion-calculator')"
        class="p-button-outlined p-button-info"
        pTooltip="Abrir calculadora de conversão"
        [disabled]="loading()">
      </p-button>-->
    </div>
  </div>

  <!-- 2. FILTERS SECTION -->
  <div class="filters-section" *ngIf="!loading()">
    <div class="filters-row">
      <!-- Search Filter -->
      <div class="filter-item search-filter">
        <p></p>
        <span class="p-input-icon-left search-container">
          <input
            #searchInput
            id="search"
            type="text"
            pInputText
            [value]="searchTerm()"
            (input)="onSearchChange($event)"
            placeholder="Buscar por símbolo ou nome..."
            class="search-input w-full"
            autocomplete="off">
        </span>
        <p-button
          *ngIf="searchTerm()"
          icon="pi pi-times"
          (onClick)="clearSearch()"
          class="p-button-text p-button-sm clear-search-btn"
          pTooltip="Limpar busca"
          tooltipPosition="top">
        </p-button>
      </div>

      <!-- Status Filter 
      <div class="filter-item status-filter">
        <label for="statusFilter" class="filter-label">Status</label>
        <p-select
          id="statusFilter"
          [options]="statusOptions"
          [ngModel]="selectedStatusFilter()"
          (onChange)="onStatusChange($event.value)"
          placeholder="Todos os status"
          optionLabel="label"
          optionValue="value"
          styleClass="filter-select">
        </p-select>
      </div>-->

      <!-- Type Filter 
      <div class="filter-item type-filter">
        <label for="typeFilter" class="filter-label">Tipo</label>
        <p-select
          id="typeFilter"
          [options]="typeOptionsArray()"
          [ngModel]="getCustomFilterValue('tipo')"
          (onChange)="onCustomFilterChange('tipo', $event.value)"
          placeholder="Todos os tipos"
          optionLabel="label"
          optionValue="value"
          styleClass="filter-select">
        </p-select>
      </div>-->
    </div>
  </div>

  <!-- 3. DATA TABLE SECTION -->
  <div class="table-section">
    <div *ngIf="!loading()">
      <p-table
        [value]="filteredData()"
        [loading]="loading()"
        (refresh)="carregarItens()"
        [paginator]="true"
        [rows]="15"
        [rowsPerPageOptions]="[15, 30, 50]"
        [sortMode]="'multiple'"
        [multiSortMeta]="multiSortMeta()"        
        responsiveLayout="scroll"
        styleClass="p-datatable-gridlines p-datatable-striped reference-table"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
        [resizableColumns]="true"
        columnResizeMode="expand"
        [tableStyle]="{ 'min-width': '50rem' }">
        <ng-template pTemplate="header">
          <tr>
            <th *ngFor="let col of displayColumns()" [pSortableColumn]="col.sortable ? col.field : null" [style.width]="col.width">
              {{ col.header }}
              <p-sortIcon *ngIf="col.sortable" [field]="col.field"></p-sortIcon>
            </th>
            <th style="width: 120px">Ações</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
          <tr>
            <td *ngFor="let col of displayColumns()">
              {{ item[col.field] }}
            </td>
            <td>
              <div class="table-actions">
                <p-button icon="pi pi-pencil" class="p-button-rounded p-button-text" (click)="editItem(item)" pTooltip="Editar" tooltipPosition="top"></p-button>
                <p-button icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger" (click)="deleteItem(item)" pTooltip="Excluir" tooltipPosition="top"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td [attr.colspan]="displayColumns().length + 1" class="text-center">
              <div class="empty-state">
                <i class="pi pi-info-circle" style="font-size: 2rem; color: var(--text-color-secondary);"></i>
                <p>Nenhuma unidade de medida encontrada.</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Actions Template for the table -->
  <ng-template #actionsTemplate let-item>
    <div class="table-actions">
      <p-button icon="pi pi-pencil" class="p-button-rounded p-button-text" (click)="editItem(item)" pTooltip="Editar" tooltipPosition="top"></p-button>
      <p-button icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger" (click)="deleteItem(item)" pTooltip="Excluir" tooltipPosition="top"></p-button>
    </div>
  </ng-template>

  <!-- 4. DIALOG (FORM) SECTION -->
  <p-dialog
    [header]="dialogTitle()"
    [visible]="showDialog()"
    (visibleChange)="showDialog.set($event)"
    [modal]="true"
    [style]="{ width: '450px' }"
    styleClass="reference-dialog"
    (onHide)="hideDialog()">
    
    <form [formGroup]="form" (ngSubmit)="save()" class="reference-form">
      <!-- Símbolo -->
      <div class="field">
        <label for="simbolo">Símbolo <span class="required-marker">*</span></label>
        <input id="simbolo" type="text" pInputText formControlName="simbolo" [readonly]="isEditMode()" />
        <app-field-error [control]="form.controls.simbolo" fieldName="Símbolo"></app-field-error>
        <small class="field-help">O símbolo é único e não pode ser alterado após a criação.</small>
      </div>

      <!-- Nome -->
      <div class="field">
        <label for="nome">Nome <span class="required-marker">*</span></label>
        <input id="nome" type="text" pInputText formControlName="nome" />
        <app-field-error [control]="form.controls.nome" fieldName="Nome"></app-field-error>
      </div>

      <!-- Tipo -->
      <div class="field">
        <label for="tipo">Tipo <span class="required-marker">*</span></label>
  <p-select id="tipo" [options]="typeOptionsArray()" formControlName="tipo" placeholder="Selecione um tipo"></p-select>
        <app-field-error [control]="form.controls.tipo" fieldName="Tipo"></app-field-error>
      </div>

      <!-- Fator de Conversão -->
      <div class="field">
        <label for="fatorConversao">Fator de Conversão <span class="required-marker">*</span></label>
        <p-inputNumber id="fatorConversao" formControlName="fatorConversao" mode="decimal" [minFractionDigits]="2" [maxFractionDigits]="8"></p-inputNumber>
        <app-field-error [control]="form.controls.fatorConversao" fieldName="Fator de Conversão"></app-field-error>
        <small class="field-help">Valor para converter esta unidade para a unidade base (e.g., 1000 para g -> kg).</small>
      </div>

      <!-- Status -->
      <div class="field-checkbox">
        <p-checkbox formControlName="ativo" [binary]="true" inputId="ativo"></p-checkbox>
        <label for="ativo">Ativo</label>
      </div>

      <!-- Dialog Footer -->
      <div class="dialog-footer">
        <p-button label="Cancelar" icon="pi pi-times" styleClass="p-button-text" (click)="hideDialog()"></p-button>
        <p-button type="submit" [label]="isEditMode() ? 'Salvar Alterações' : 'Criar Unidade'" icon="pi pi-check" [loading]="saving()"></p-button>
      </div>
    </form>
  </p-dialog>

</div>
